{% extends "layout.html" %}

{% block content %}
<!-- Статистика -->
<div class="card">
    <div class="flex justify-between">
        <h2 class="flex" style="margin-bottom:0">
            <i data-lucide="bar-chart-2" style="color: var(--accent-primary)"></i>
            Статистика
        </h2>
        <button class="btn btn-danger flex" onclick="clearAll()">
            <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
            Очистить всю историю
        </button>
    </div>
    <div
        style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem;">
        <!-- Всего чатов -->
        <div class="stat-card"
            style="background: rgba(107, 70, 193, 0.05); padding: 1.25rem; border-radius: 20px; border: 1px solid rgba(107, 70, 193, 0.1);">
            <div class="flex" style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;">
                <i data-lucide="message-square"
                    style="width: 18px; height: 18px; margin-right: 0.5rem; color: var(--accent-primary);"></i>
                Всего чатов
            </div>
            <div style="display: flex; align-items: baseline; gap: 0.75rem;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">{{ stats.chats_count }}
                </div>
                <div style="font-size: 0.85rem; color: var(--success); font-weight: 500;">
                    <i data-lucide="trending-up"
                        style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;"></i>
                    {{ stats.active_chats_24h }} за 24ч
                </div>
            </div>
        </div>

        <!-- Сообщений всего -->
        <div class="stat-card"
            style="background: rgba(16, 185, 129, 0.05); padding: 1.25rem; border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.1);">
            <div class="flex" style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;">
                <i data-lucide="send"
                    style="width: 18px; height: 18px; margin-right: 0.5rem; color: var(--success);"></i>
                Сообщений всего
            </div>
            <div style="display: flex; align-items: baseline; gap: 0.75rem;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">{{ stats.total_messages }}
                </div>
                <div style="font-size: 0.85rem; color: var(--success); font-weight: 500;">
                    +{{ stats.messages_24h }} за 24ч
                </div>
            </div>
        </div>

        <!-- Распределение Платформ -->
        <div class="stat-card"
            style="background: rgba(59, 130, 246, 0.05); padding: 1.25rem; border-radius: 20px; border: 1px solid rgba(59, 130, 246, 0.1);">
            <div class="flex" style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;">
                <i data-lucide="layers" style="width: 18px; height: 18px; margin-right: 0.5rem; color: #3b82f6;"></i>
                Платформы (сообщения)
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div class="flex justify-between" style="font-size: 0.95rem;">
                    <span class="flex" style="color: #3b82f6; font-weight: 500;">
                        <i data-lucide="send" style="width: 14px; height: 14px;"></i> Telegram
                    </span>
                    <span style="font-weight: 700;">{{ stats.telegram_messages }}</span>
                </div>
                <div class="flex justify-between" style="font-size: 0.95rem;">
                    <span class="flex" style="color: #8b5cf6; font-weight: 500;">
                        <i data-lucide="gamepad-2" style="width: 14px; height: 14px;"></i> Discord
                    </span>
                    <span style="font-weight: 700;">{{ stats.discord_messages }}</span>
                </div>
            </div>
        </div>

        <!-- Активность Бота -->
        <div class="stat-card"
            style="background: rgba(245, 158, 11, 0.05); padding: 1.25rem; border-radius: 20px; border: 1px solid rgba(245, 158, 11, 0.1);">
            <div class="flex" style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;">
                <i data-lucide="cpu" style="width: 18px; height: 18px; margin-right: 0.5rem; color: #f59e0b;"></i>
                Соотношение (Role)
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div class="flex justify-between" style="font-size: 0.95rem;">
                    <span class="flex" style="color: var(--text-primary); font-weight: 500;">
                        <i data-lucide="user" style="width: 14px; height: 14px;"></i> User
                    </span>
                    <span style="font-weight: 700;">{{ stats.user_messages }}</span>
                </div>
                <div class="flex justify-between" style="font-size: 0.95rem;">
                    <span class="flex" style="color: var(--accent-primary); font-weight: 500;">
                        <i data-lucide="bot" style="width: 14px; height: 14px; color: var(--accent-primary);"></i> Bot
                    </span>
                    <span style="font-weight: 700;">{{ stats.assistant_messages }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Подключения -->
<div class="card">
    <div class="flex justify-between" style="margin-bottom: 1.5rem;">
        <h2 class="flex" style="margin:0">
            <i data-lucide="plug" style="color: var(--accent-primary)"></i>
            Подключения к LLM
        </h2>
        <button class="btn btn-primary flex" onclick="openConnModal()">
            <i data-lucide="plus-circle" style="width: 18px; height: 18px;"></i>
            Добавить подключение
        </button>
    </div>
    <table class="table-fixed">
        <thead>
            <tr>
                <th>Имя</th>
                <th>Провайдер</th>
                <th>Модель</th>
                <th>Base URL</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for c in connections %}
            <tr class="{% if c.is_active %}active{% endif %}">
                <td>{{ c.name }}</td>
                <td>{{ c.provider }}</td>
                <td title="{{ c.model_name }}">{{ c.model_name }}</td>
                <td style="font-size: 0.85rem; color: var(--text-secondary); opacity: 0.8;">{{ c.base_url or '-' }}</td>
                <td>
                    <div class="flex" style="gap: 0.5rem; justify-content: flex-end;">
                        {% if not c.is_active %}
                        <button class="btn btn-primary btn-table" style="min-width: 40px; padding: 0.4rem;"
                            onclick="activateConn({{ c.id }})" title="Активировать">
                            <i data-lucide="power" style="width: 16px; height: 16px;"></i>
                        </button>
                        {% else %}
                        <button class="btn btn-table" title="Активно"
                            style="min-width: 40px; padding: 0.4rem; background: rgba(16, 185, 129, 0.1); color: var(--success); cursor: default; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                        </button>
                        {% endif %}
                        <button class="btn btn-table"
                            style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); color: var(--text-primary);"
                            onclick="showPrompts({{ c.id }}, '{{ c.name }}')" title="Промпты">
                            <i data-lucide="terminal" style="width: 16px; height: 16px; opacity: 0.9;"></i>
                            Промпты
                        </button>
                        <button class="btn btn-table"
                            style="background: rgba(107, 70, 193, 0.05); border: 1px solid var(--accent-primary); color: var(--accent-primary);"
                            onclick="checkConn({{ c.id }})" title="Проверить">
                            <i data-lucide="activity" style="width: 16px; height: 16px;"></i>
                            Проверить
                        </button>
                        <button class="btn-transparent" onclick="editConn({{ c.id }})" title="Редактировать">
                            <i data-lucide="edit-3" style="width: 18px; height: 18px;"></i>
                        </button>
                        <button class="btn-transparent" onclick="deleteConn({{ c.id }})" title="Удалить"
                            style="color: var(--danger)">
                            <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align:center; color: var(--text-secondary);">Нет подключений</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Модальное окно подключения -->
<div id="conn_modal" class="modal-overlay" onclick="closeConnModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="conn_form_title" class="flex" style="margin:0">
                <i data-lucide="plus-circle" style="color: var(--accent-primary)"></i>
                Добавить подключение
            </h2>
            <button class="btn-transparent" onclick="closeConnModal()" style="padding:0.5rem">
                <i data-lucide="x" style="width:24px; height:24px"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <input type="text" id="conn_name" placeholder="Название (например, OpenAI)">
                <input type="hidden" id="conn_provider">
                <div class="custom-dropdown" data-input-id="conn_provider">
                    <div class="dropdown-trigger">
                        <span class="selected-text">Выберите провайдера...</span>
                        <i data-lucide="chevron-down" class="dropdown-arrow"
                            style="width: 16px; height: 16px; color: var(--text-secondary);"></i>
                    </div>
                    <div class="dropdown-menu">
                        {% for key, url in providers.items() %}
                        <div class="dropdown-option" data-value="{{ key }}">
                            {{ provider_names.get(key, key|title) }}
                        </div>
                        {% endfor %}
                        <div class="dropdown-option" data-value="custom">Другой (Custom)</div>
                    </div>
                </div>
                <input type="text" id="conn_model" placeholder="Модель (gpt-4o, anthropic/claude-3)">
                <input type="password" id="conn_key" placeholder="API Key">
                <input type="text" id="conn_url" placeholder="Base URL (optional)">
                <div class="form-actions"
                    style="margin-top: 1.5rem; display: flex; gap: 1rem; width: 100%; justify-content: flex-end;">
                    <button id="conn_check_btn" onclick="checkCurrentConn()" class="btn"
                        style="background:transparent; border:1px solid var(--accent-primary); color: var(--accent-primary);">
                        <i data-lucide="activity" style="width: 16px; height: 16px;"></i>
                        Проверить
                    </button>
                    <div style="flex-grow: 1;"></div>
                    <button id="conn_cancel_btn" onclick="closeConnModal()" class="btn"
                        style="background:transparent; border:1px solid var(--border-color);">
                        Отмена
                    </button>
                    <button id="conn_submit_btn" onclick="addConn()" class="btn btn-primary">
                        <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно промптов -->
<div id="prompts_modal" class="modal-overlay" onclick="closePrompts(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="flex" style="margin:0">
                <i data-lucide="terminal" style="color: var(--accent-primary)"></i>
                Промпты для <span id="current_conn_name" style="color:var(--accent-primary)"></span>
            </h2>
            <button class="btn-transparent" onclick="closePrompts()" style="padding:0.5rem">
                <i data-lucide="x" style="width:24px; height:24px"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="prompts_list"></div>

            <div id="prompt_form" class="card" style="margin-top: 1.5rem; background: rgba(255,255,255,0.02)">
                <h3 id="prompt_form_title" style="margin-bottom:1.25rem">Добавить промпт</h3>
                <div class="form-group">
                    <input type="text" id="prompt_name" placeholder="Название промпта">
                    <textarea id="prompt_content" placeholder="Текст системного промпта" rows="5"></textarea>
                    <div class="flex justify-end" style="margin-top: 1.5rem; gap: 1rem;">
                        <button id="prompt_cancel_btn" onclick="cancelEditPrompt()" class="btn"
                            style="display:none; background:transparent; border:1px solid var(--border-color);">
                            Отмена
                        </button>
                        <button id="prompt_submit_btn" onclick="submitPrompt()" class="btn btn-primary">
                            <i data-lucide="plus-square" style="width: 16px; height: 16px;"></i>
                            Добавить промпт
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Активные чаты -->
<div class="card">
    <h2 class="flex">
        <i data-lucide="users" style="color: var(--accent-primary)"></i>
        Активные чаты
    </h2>
    <table class="chats-table">
        <thead>
            <tr>
                <th>Платформа</th>
                <th>Тип</th>
                <th>ID Чата</th>
                <th>Название</th>
                <th>Сообщений</th>
                <th>Whitelist</th>
                <th>Последняя активность</th>
                <th style="text-align: right;">Управление</th>
            </tr>
        </thead>
        <tbody id="active_chats_body">
            {% for c in chats|sort(attribute='last_message_at', reverse=True) %}
            <tr>
                <td>
                    {% if c.platform == 'telegram' %}
                    <div class="flex" title="Telegram" style="color: #3b82f6;">
                        <i data-lucide="send" style="width: 16px; height: 16px;"></i>
                    </div>
                    {% elif c.platform == 'discord' %}
                    <div class="flex" title="Discord" style="color: #8b5cf6;">
                        <i data-lucide="gamepad-2" style="width: 16px; height: 16px;"></i>
                    </div>
                    {% else %}
                    {{ c.platform }}
                    {% endif %}
                </td>
                <td>
                    {% if c.chat_type == 'private' %}
                    <i data-lucide="user" title="Личное сообщение" style="width: 16px; height: 16px; opacity: 0.7;"></i>
                    {% else %}
                    <i data-lucide="users" title="Группа/Сервер" style="width: 16px; height: 16px; opacity: 0.7;"></i>
                    {% endif %}
                </td>
                <td style="font-family: monospace; font-size: 0.9rem; opacity: 0.8;">{{ c.chat_id }}</td>
                <td style="font-weight: 500;">{{ c.title }}</td>
                <td>
                    <span class="badge"
                        style="background: rgba(107, 70, 193, 0.1); color: var(--accent-primary); padding: 0.2rem 0.6rem; border-radius: 10px; font-weight: 600;">
                        {{ c.message_count }}
                    </span>
                </td>
                <td>
                    {% if c.is_allowed %}
                    <span class="flex" style="color: var(--success); font-size: 0.85rem; font-weight: 500;">
                        <i data-lucide="check-circle" style="width: 14px; height: 14px; margin-right: 0.4rem;"></i>
                        В списке
                    </span>
                    {% else %}
                    <span class="flex" style="color: var(--text-secondary); font-size: 0.85rem; opacity: 0.6;">
                        <i data-lucide="minus-circle" style="width: 14px; height: 14px; margin-right: 0.4rem;"></i>
                        Нет
                    </span>
                    {% endif %}
                </td>
                <td style="font-size: 0.85rem; color: var(--text-secondary);">
                    {{ c.last_message_at.strftime('%H:%M %d.%m') if c.last_message_at else '-' }}
                </td>
                <td>
                    <div class="flex justify-end">
                        <button class="btn btn-danger flex"
                            style="padding:0.4rem 0.8rem; font-size:0.8rem; border-radius: 10px;"
                            onclick="clearChat({{ c.chat_id }}, '{{ c.platform }}')">
                            <i data-lucide="trash-2" style="width: 14px; height: 14px; margin-right: 0.4rem;"></i>
                            Очистить
                        </button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" style="text-align:center; padding: 2rem; color: var(--text-secondary);">Нет активных
                    диалогов</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Модальное окно подтверждения -->
<div id="confirm_modal" class="modal-overlay" style="z-index: 1000010; display: none;">
    <div class="modal-content" style="max-width: 420px; padding: 2rem; border-radius: 28px;">
        <div class="modal-header"
            style="border-bottom: none; padding: 0.5rem 0 0.5rem 0; justify-content: center; position: relative;">
            <h3 id="confirm_title"
                style="margin:0; font-size: 1.25rem; text-transform: uppercase; letter-spacing: 0.1em; text-align: center;">
                Подтвердите действие
            </h3>
            <button class="btn-transparent" id="confirm_cross_btn"
                style="position: absolute; right: -0.5rem; top: -0.5rem; padding: 0.5rem; opacity: 0.6;">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 1.5rem 0 2rem 0; text-align: center;">
            <p id="confirm_message"
                style="margin:0; color: var(--text-secondary); font-size: 1.05rem; line-height: 1.6;"></p>
        </div>
        <div class="modal-actions" style="justify-content: center;">
            <button id="confirm_ok_btn" class="btn btn-primary" style="height: 48px;">ОК</button>
            <button id="confirm_cancel_btn" class="btn"
                style="height: 48px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); color: var(--text-secondary);">Отмена</button>
        </div>
    </div>
</div>
<!-- Модальное окно настроек -->
<div id="settings_modal" class="modal-overlay" onclick="closeSettingsModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="flex" style="margin:0">
                <i data-lucide="settings" style="color: var(--accent-primary)"></i>
                Настройки доступа
            </h2>
            <button class="btn-transparent" onclick="closeSettingsModal()" style="padding:0.5rem">
                <i data-lucide="x" style="width:24px; height:24px"></i>
            </button>
        </div>
        <div class="settings-tabs">
            <div class="tab-item active" onclick="switchSettingsTab('telegram')">
                <i data-lucide="send" style="width: 16px; height: 16px;"></i>
                Telegram
            </div>
            <div class="tab-item" onclick="switchSettingsTab('discord')">
                <i data-lucide="gamepad-2" style="width: 16px; height: 16px;"></i>
                Discord
            </div>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div class="settings-content" style="padding: 1.5rem;">
                <!-- Telegram Settings -->
                <div id="tab_telegram" class="tab-pane active">
                    <div class="card" style="margin-bottom: 1.5rem; background: rgba(255,255,255,0.02)">
                        <div class="flex justify-between" style="margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin:0 0 0.25rem 0">Включить Telegram бота</h3>
                                <p style="margin:0; color:var(--text-secondary); font-size:0.85rem">
                                    Основной бот для Telegram
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting_tg_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex justify-between"
                            style="margin-bottom: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                            <div>
                                <h3 style="margin:0 0 0.25rem 0">Приватные сообщения</h3>
                                <p style="margin:0; color:var(--text-secondary); font-size:0.85rem">
                                    Разрешить отвечать в ЛС
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting_tg_private">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex justify-between" style="align-items: center;">
                            <div>
                                <h3 style="margin:0 0 0.25rem 0">История сообщений</h3>
                                <p style="margin:0; color:var(--text-secondary); font-size:0.85rem">
                                    Количество запоминаемых сообщений
                                </p>
                            </div>
                            <input type="number" id="setting_tg_memory" class="input-tiny" value="10" min="0" max="100">
                        </div>
                    </div>

                    <div class="card" style="background: rgba(255,255,255,0.02)">
                        <h3 style="margin-bottom:1rem">Белый список (Telegram)</h3>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <div class="flex" style="gap: 0.5rem;">
                                <input type="text" id="whitelist_tg_id" placeholder="Chat ID" style="flex-grow:1">
                                <input type="text" id="whitelist_tg_title" placeholder="Название" style="flex-grow:1">
                                <button class="btn btn-primary" onclick="addWhitelistItem('telegram')">
                                    <i data-lucide="plus"></i>
                                </button>
                            </div>
                        </div>
                        <div id="whitelist_list_telegram" class="whitelist-container"></div>
                    </div>
                </div>

                <!-- Discord Settings -->
                <div id="tab_discord" class="tab-pane">
                    <div class="card" style="margin-bottom: 1.5rem; background: rgba(255,255,255,0.02)">
                        <div class="flex justify-between" style="margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin:0 0 0.25rem 0">Включить Discord бота</h3>
                                <p style="margin:0; color:var(--text-secondary); font-size:0.85rem">
                                    Бот для сервера Discord
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting_dc_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex justify-between"
                            style="margin-bottom: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                            <div>
                                <h3 style="margin:0 0 0.25rem 0">Личные сообщения</h3>
                                <p style="margin:0; color:var(--text-secondary); font-size:0.85rem">
                                    Разрешить отвечать в ЛС (по умолчанию выкл)
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting_dc_dm">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex justify-between" style="align-items: center;">
                            <div>
                                <h3 style="margin:0 0 0.25rem 0">История сообщений</h3>
                                <p style="margin:0; color:var(--text-secondary); font-size:0.85rem">
                                    Количество запоминаемых сообщений
                                </p>
                            </div>
                            <input type="number" id="setting_dc_memory" class="input-tiny" value="10" min="0" max="100">
                        </div>
                    </div>

                    <div class="card" style="background: rgba(255,255,255,0.02)">
                        <h3 style="margin-bottom:1rem">Белый список (Discord)</h3>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <div class="flex" style="gap: 0.5rem;">
                                <input type="text" id="whitelist_dc_id" placeholder="Channel/Server ID"
                                    style="flex-grow:1">
                                <input type="text" id="whitelist_dc_title" placeholder="Название" style="flex-grow:1">
                                <button class="btn btn-primary" onclick="addWhitelistItem('discord')">
                                    <i data-lucide="plus"></i>
                                </button>
                            </div>
                        </div>
                        <div id="whitelist_list_discord" class="whitelist-container"></div>
                    </div>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveSettings()">Сохранить настройки</button>
        </div>
    </div>
</div>

{% endblock %}