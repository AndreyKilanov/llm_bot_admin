{% extends "layout.html" %}

{% block content %}
<!-- Статистика -->
<div class="card">
    <div class="flex justify-between">
        <h2 class="flex" style="margin-bottom:0">
            <i data-lucide="bar-chart-2" style="color: var(--accent-primary)"></i>
            Статистика
        </h2>
        <button class="btn btn-danger flex" onclick="clearAll()">
            <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
            Очистить всю историю
        </button>
    </div>
    <div style="margin-top: 1rem; display: flex; gap: 2rem; font-size: 1.1rem;">
        <div class="flex">
            <i data-lucide="message-square" style="color: var(--accent-primary); width: 18px; height: 18px;"></i>
            <strong>Чатов:</strong> {{ stats.chats_count }}
        </div>
        <div class="flex">
            <i data-lucide="send" style="color: var(--accent-primary); width: 18px; height: 18px;"></i>
            <strong>Сообщений:</strong> {{ stats.total_messages }}
        </div>
    </div>
</div>

<!-- Подключения -->
<div class="card">
    <div class="flex justify-between" style="margin-bottom: 1.5rem;">
        <h2 class="flex" style="margin:0">
            <i data-lucide="plug" style="color: var(--accent-primary)"></i>
            Подключения к LLM
        </h2>
        <button class="btn btn-primary flex" onclick="openConnModal()">
            <i data-lucide="plus-circle" style="width: 18px; height: 18px;"></i>
            Добавить подключение
        </button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Имя</th>
                <th>Провайдер</th>
                <th>Модель</th>
                <th>Base URL</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for c in connections %}
            <tr class="{% if c.is_active %}active{% endif %}">
                <td>{{ c.name }}</td>
                <td>{{ c.provider }}</td>
                <td title="{{ c.model_name }}">{{ c.model_name }}</td>
                <td style="font-size: 0.85rem; color: var(--text-secondary); opacity: 0.8;">{{ c.base_url or '-' }}</td>
                <td>
                    <div class="flex" style="gap: 0.5rem; justify-content: flex-end;">
                        {% if not c.is_active %}
                        <button class="btn btn-primary btn-table" style="min-width: 40px; padding: 0.4rem;"
                            onclick="activateConn({{ c.id }})" title="Активировать">
                            <i data-lucide="power" style="width: 16px; height: 16px;"></i>
                        </button>
                        {% else %}
                        <button class="btn btn-table" title="Активно"
                            style="min-width: 40px; padding: 0.4rem; background: rgba(16, 185, 129, 0.1); color: var(--success); cursor: default; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                        </button>
                        {% endif %}
                        <button class="btn btn-table"
                            style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); color: var(--text-primary);"
                            onclick="showPrompts({{ c.id }}, '{{ c.name }}')" title="Промпты">
                            <i data-lucide="terminal" style="width: 16px; height: 16px; opacity: 0.9;"></i>
                            Промпты
                        </button>
                        <button class="btn btn-table"
                            style="background: rgba(107, 70, 193, 0.05); border: 1px solid var(--accent-primary); color: var(--accent-primary);"
                            onclick="checkConn({{ c.id }})" title="Проверить">
                            <i data-lucide="activity" style="width: 16px; height: 16px;"></i>
                            Проверить
                        </button>
                        <button class="btn-transparent" onclick="editConn({{ c.id }})" title="Редактировать">
                            <i data-lucide="edit-3" style="width: 18px; height: 18px;"></i>
                        </button>
                        <button class="btn-transparent" onclick="deleteConn({{ c.id }})" title="Удалить"
                            style="color: var(--danger)">
                            <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align:center; color: var(--text-secondary);">Нет подключений</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Модальное окно подключения -->
<div id="conn_modal" class="modal-overlay" onclick="closeConnModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="conn_form_title" class="flex" style="margin:0">
                <i data-lucide="plus-circle" style="color: var(--accent-primary)"></i>
                Добавить подключение
            </h2>
            <button class="btn-transparent" onclick="closeConnModal()" style="padding:0.5rem">
                <i data-lucide="x" style="width:24px; height:24px"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <input type="text" id="conn_name" placeholder="Название (например, OpenAI)">
                <select id="conn_provider" onchange="onProviderChange()">
                    <option value="" disabled selected>Выберите провайдера...</option>
                    <option value="openrouter">OpenRouter</option>
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                    <option value="google">Google (Gemini)</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="groq">Groq</option>
                    <option value="custom">Другой (Custom)</option>
                </select>
                <input type="text" id="conn_model" placeholder="Модель (gpt-4o, anthropic/claude-3)">
                <input type="password" id="conn_key" placeholder="API Key">
                <input type="text" id="conn_url" placeholder="Base URL (optional)">
                <div class="form-actions"
                    style="margin-top: 1.5rem; display: flex; gap: 1rem; width: 100%; justify-content: flex-end;">
                    <button id="conn_check_btn" onclick="checkCurrentConn()" class="btn"
                        style="background:transparent; border:1px solid var(--accent-primary); color: var(--accent-primary);">
                        <i data-lucide="activity" style="width: 16px; height: 16px;"></i>
                        Проверить
                    </button>
                    <div style="flex-grow: 1;"></div>
                    <button id="conn_cancel_btn" onclick="closeConnModal()" class="btn"
                        style="background:transparent; border:1px solid var(--border-color);">
                        Отмена
                    </button>
                    <button id="conn_submit_btn" onclick="addConn()" class="btn btn-primary">
                        <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно промптов -->
<div id="prompts_modal" class="modal-overlay" onclick="closePrompts(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="flex" style="margin:0">
                <i data-lucide="terminal" style="color: var(--accent-primary)"></i>
                Промпты для <span id="current_conn_name" style="color:var(--accent-primary)"></span>
            </h2>
            <button class="btn-transparent" onclick="closePrompts()" style="padding:0.5rem">
                <i data-lucide="x" style="width:24px; height:24px"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="prompts_list"></div>

            <div class="card" style="margin-top: 1.5rem; background: rgba(255,255,255,0.02)">
                <h3 id="prompt_form_title" style="margin-bottom:1.25rem">Добавить промпт</h3>
                <div class="form-group">
                    <input type="text" id="prompt_name" placeholder="Название промпта">
                    <textarea id="prompt_content" placeholder="Текст системного промпта" rows="5"></textarea>
                    <div class="flex" style="margin-top: 1rem;">
                        <button id="prompt_submit_btn" onclick="submitPrompt()" class="btn btn-primary flex">
                            <i data-lucide="plus-square" style="width: 16px; height: 16px;"></i>
                            Добавить промпт
                        </button>
                        <button id="prompt_cancel_btn" onclick="cancelEditPrompt()" class="btn flex"
                            style="display:none; background:transparent; border:1px solid var(--border-color);">
                            Отмена
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Активные чаты -->
<div class="card">
    <h2 class="flex">
        <i data-lucide="users" style="color: var(--accent-primary)"></i>
        Активные чаты
    </h2>
    <table>
        <thead>
            <tr>
                <th>ID Чата</th>
                <th>Сообщений</th>
                <th>Управление</th>
            </tr>
        </thead>
        <tbody>
            {% for c in chats|sort(attribute='message_count', reverse=True) %}
            <tr>
                <td>{{ c.chat_id }}</td>
                <td>{{ c.message_count }}</td>
                <td>
                    <button class="btn btn-danger flex" style="padding:0.25rem 0.6rem; font-size:0.8rem;"
                        onclick="clearChat({{ c.chat_id }})">
                        <i data-lucide="trash" style="width: 14px; height: 14px;"></i>
                        Очистить
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3" style="text-align:center;">Нет данных</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Модальное окно подтверждения -->
<div id="confirm_modal" class="modal-overlay" style="z-index: 1000010; display: none;">
    <div class="modal-content" style="max-width: 420px; padding: 2rem; border-radius: 28px;">
        <div class="modal-header"
            style="border-bottom: none; padding: 0.5rem 0 0.5rem 0; justify-content: center; position: relative;">
            <h3 id="confirm_title"
                style="margin:0; font-size: 1.25rem; text-transform: uppercase; letter-spacing: 0.1em; text-align: center;">
                Подтвердите действие
            </h3>
            <button class="btn-transparent" id="confirm_cross_btn"
                style="position: absolute; right: -0.5rem; top: -0.5rem; padding: 0.5rem; opacity: 0.6;">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 1.5rem 0 2rem 0; text-align: center;">
            <p id="confirm_message"
                style="margin:0; color: var(--text-secondary); font-size: 1.05rem; line-height: 1.6;"></p>
        </div>
        <div class="flex" style="gap: 1rem; justify-content: center; width: 100%;">
            <button id="confirm_ok_btn" class="btn btn-primary"
                style="min-width: 120px; justify-content: center; height: 48px;">ОК</button>
            <button id="confirm_cancel_btn" class="btn"
                style="min-width: 120px; justify-content: center; height: 48px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); color: var(--text-secondary);">Отмена</button>
        </div>
    </div>
</div>
<!-- Модальное окно настроек -->
<div id="settings_modal" class="modal-overlay" onclick="closeSettingsModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="flex" style="margin:0">
                <i data-lucide="settings" style="color: var(--accent-primary)"></i>
                Настройки доступа
            </h2>
            <button class="btn-transparent" onclick="closeSettingsModal()" style="padding:0.5rem">
                <i data-lucide="x" style="width:24px; height:24px"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Приватные чаты -->
            <div class="card" style="margin-bottom: 1.5rem; background: rgba(255,255,255,0.02)">
                <div class="flex justify-between">
                    <div>
                        <h3 style="margin:0 0 0.5rem 0">Приватные сообщения</h3>
                        <p style="margin:0; color:var(--text-secondary); font-size:0.9rem">
                            Разрешить боту отвечать в личных сообщениях
                        </p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="setting_private_chat" onchange="togglePrivateChat()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- Белый список групп -->
            <div class="card" style="background: rgba(255,255,255,0.02)">
                <h3 style="margin-bottom:1rem">Белый список групп</h3>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <div class="flex" style="gap: 0.5rem;">
                        <input type="text" id="whitelist_chat_id" placeholder="Chat ID (например -100...)"
                            style="flex-grow:1">
                        <input type="text" id="whitelist_title" placeholder="Название (опционально)"
                            style="flex-grow:1">
                        <button class="btn btn-primary" onclick="addWhitelistItem()">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                </div>

                <div id="whitelist_list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Items will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}